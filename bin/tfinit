#!/bin/bash

set -eo pipefail

stateBucket=""
TF_VAR_environment="default"

for arg in "$@"; do
  case $arg in
  --env=*)
    TF_VAR_environment=${arg#--env=}
    ;;
  --state-bucket=*)
    stateBucket=${arg#--state-bucket=}
    ;;
  esac
done

if [ ! "${stateBucket}" == "" ]; then
  sed -i "s/STATE_BUCKET/${stateBucket}/" backend.tf
fi

echo '--- :terraform: Init'
terraform init

if [ "${TF_VAR_environment}" == "default" ]; then
  terraform workspace select default
else
  terraform workspace new $TF_VAR_environment
  terraform workspace select $TF_VAR_environment
fi