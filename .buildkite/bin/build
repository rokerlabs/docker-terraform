#!/bin/bash

set -eo pipefail

latest="true"
imageRepo="${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"

if [ -z "${TERRAFORM_VERSION}" ]; then
    latestReleaseTag=$(curl -s https://api.github.com/repos/hashicorp/terraform/releases/latest | jq -r '.tag_name')
    export TERRAFORM_VERSION=${latestReleaseTag#v}

    if [ "${BUILDKITE}" == "true" ]; then
        buildkite-agent meta-data set terraform-version $TERRAFORM_VERSION
    fi
else
    latest="false"
fi

minor=$TERRAFORM_VERSION
major=${TERRAFORM_VERSION%.*}

echo "+++ :docker: Build ${imageRepo}:${minor}"

docker build . \
    --build-arg TERRAFORM_VERSION \
    -t ${imageRepo}:beta \
    -t ${imageRepo}:${major}-beta \
    -t ${imageRepo}:${minor}-beta

if [ "${BUILDKITE_BRANCH}" == "master" ]; then
    echo "--- :docker: Push ${imageRepo}:${minor}-beta"
    docker push ${imageRepo}:${minor}-beta

    if [ "${latest}" == "true" ]; then
        echo "--- :docker: Push ${imageRepo}:${major}-beta"
        docker push ${imageRepo}:${major}-beta

        echo "--- :docker: Push ${imageRepo}:beta"
        docker push ${imageRepo}:beta
    fi
fi