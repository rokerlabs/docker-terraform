#!/bin/bash

set -eo pipefail

imageRepo="${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"

if [ "${BUILDKITE}" == "true" ]; then
    version=$(buildkite-agent meta-data get terraform-version)
    minor=$version
    major=${version%.*}

    docker pull ${imageRepo}:${minor}-beta

    echo "+++ :docker: Tag ${imageRepo}:${minor}-beta => ${imageRepo}:${minor}"
    docker tag ${imageRepo}:${minor}-beta ${imageRepo}:${minor}
    docker push ${imageRepo}:${minor}

    echo "+++ :docker: Tag ${imageRepo}:${minor}-beta => ${imageRepo}:${major}"
    docker tag ${imageRepo}:${minor}-beta ${imageRepo}:${major}
    docker push ${imageRepo}:${major}

    echo "+++ :docker: Tag ${imageRepo}:${minor}-beta => ${imageRepo}:latest"
    docker tag ${imageRepo}:${minor}-beta ${imageRepo}:latest
    docker push ${imageRepo}:latest
else
    echo "ERROR   Docker image cannot be released outside of the Buildkite pipeline!"
    exit 1
fi