#!/bin/bash

set -eo pipefail

if [ ! -z "$TERRAFORM_AWS_ACCESS_KEY_ID" ] && [ ! -z "$TERRAFORM_AWS_SECRET_ACCESS_KEY" ]; then
  export AWS_ACCESS_KEY_ID=$TERRAFORM_AWS_ACCESS_KEY_ID
  export AWS_SECRET_ACCESS_KEY=$TERRAFORM_AWS_SECRET_ACCESS_KEY
fi

stateBucket=""
TF_VAR_environment="default"

for arg in "$@"; do
  case $arg in
  --env=*)
    export TF_VAR_environment=${arg#--env=}
    ;;
  --state-bucket=*)
    stateBucket=${arg#--state-bucket=}
    ;;
  esac
done

if [ ! "${stateBucket}" == "" ]; then
  sed -i "s/STATE_BUCKET/${stateBucket}/" backend.tf
fi

echo '--- :terraform: Init'
terraform init

if [ "${TF_VAR_environment}" == "default" ]; then
  terraform workspace select default
else
  terraform workspace new $TF_VAR_environment
  terraform workspace select $TF_VAR_environment
fi

echo '+++ :terraform: Apply'
terraform apply -auto-approve